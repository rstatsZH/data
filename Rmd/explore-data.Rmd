---
title: "Untitled"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
```

# Daten - Kursteilnehmer_innen

Kursteilnehmer_innen werden als Vorbereitung auf den Kurs darum gebeten opendata.swiss zu öffnen und einen Datensatz im CSV Format zu identifizieren welcher sie interessiert. Die Datensätze werden auf Slack geteilt mit einer kurzen Begründung warum der Datensatz interessiert und warum dieser ausgewählt wurde.

## rstatsZH-K001


### Verzeichnis der Personenstammdaten der zentralen Verwaltung des Kantons Zürich 

- https://opendata.swiss/de/dataset/verzeichnis-der-personenstammdaten-der-zentralen-verwaltung-des-kantons-zurich

```{r}

stammdat_link1 <- "https://www.web.statistik.zh.ch/ogd/data/personenstammdatenverzeichnis_merkmale_register_systeme.csv"

stammdat_link2 <- "https://www.web.statistik.zh.ch/ogd/data/personenstammdatenverzeichnis_merkmale_verwaltungseinheiten.csv"

stammdat_link3 <- "https://www.web.statistik.zh.ch/ogd/data/personenstammdatenverzeichnis_abkuerzungen_definitionen.csv"

dat1 <- read_csv(stammdat_link1)
dat2 <- read_csv(stammdat_link2)

dat1 %>% 
  pivot_longer(UPI:betreibungsregister, names_to = "register", values_to = "erlaubnis") %>% 
  count(erlaubnis)

dat2 %>% 
  pivot_longer(3:49, names_to = "verwaltungseinheit", values_to = "erlaubnis") %>% 
  group_by(verwaltungseinheit, erlaubnis) %>% 
  count() %>% 
  arrange(erlaubnis)

```


### Kosten des Gesundheitswesens nach Leistungen 

- https://opendata.swiss/de/dataset/kosten-des-gesundheitswesens-nach-leistungen6

```{r}

library(readxl) # https://readxl.tidyverse.org/

# was sehen wir?
# read_excel(path = here::here("data/raw/je-d-14.05.01.03.xlsx"))

gesundheit <- read_excel(path = here::here("data/raw/je-d-14.05.01.03.xlsx"), 
           skip = 2, 
           n_max = 43)

gesundheit_total <- gesundheit %>% 
  slice(-1) %>% 
  filter(str_length(...1) == 1) %>% 
  rename(kategorie_code = ...1,
         kategorie_name = ...2) %>% 
  pivot_longer(cols = !c(kategorie_code, kategorie_name), 
               names_to = "jahr", 
               values_to = "mio_chf") %>% 
  mutate(jahr = as.numeric(jahr))

gesundheit_total %>% 
  ggplot(aes(x = jahr, y = mio_chf, group = kategorie_name, color = kategorie_name)) +
  geom_line() 


gesundheit_sparte <- gesundheit %>% 
  slice(-1) %>% 
  mutate(kategorie_code = case_when(
    str_length(...1) == 1 ~ ...1,
    TRUE ~ NA_character_
  )) %>% 
  relocate(kategorie_code) %>% 
  fill(kategorie_code) %>% 
  filter(str_length(...1) > 1) %>% 
  rename(sparte_code = ...1,
         sparte_name = ...2) %>% 
  pivot_longer(cols = !kategorie_code:sparte_name,
               names_to = "jahr",
               values_to = "mio_chf", 
               values_drop_na = TRUE) %>% 
  mutate(jahr = as.numeric(jahr))


gesundheit_sparte %>% 
  ggplot(aes(x = jahr, y = mio_chf, group = sparte_code)) +
  geom_line() +
  facet_wrap(~kategorie_code, scales = "free_y") +
  




```



### Ehedaten Kanton Zürich 16. bis 18. Jahrhundert 

https://opendata.swiss/de/dataset/ehedaten-kanton-zurich-16-bis-18-jahrhundert

### Daten importieren

```{r}

download_link <- "https://zenodo.org/record/3964315/files/EDB_16_18_Jh_Stand_2020_07_22.CSV?download=1"

ehedaten <- read_delim(download_link, delim = ";",
                       locale = locale(encoding = "ISO-8859-1")) 


```

### Daten transformieren

```{r}

## Was macht die Funktion `clean_names()` aus dem `janitor` R Package?

ehedaten_tidy <- ehedaten %>% 
  janitor::clean_names() %>% 
  select(-signatur, -seite_im_band, -weblink) %>% 
  mutate(datum = parse_date(entstehungszeitraum, format = "%Y.%m.%d")) %>% 
  select(-entstehungszeitraum) %>% 
  filter(!is.na(datum)) %>% 
  mutate(
    jahr = year(datum),
    monat = month(datum, label = TRUE),
    tag = day(datum),
    wochentag = wday(datum, label = TRUE, week_start = 1)
  )

## Könnten separate nutzen um die Jahre mit Monat nicht zu verlieren
## separate(col = entstehungszeitraum,  into = c("jahr", "monat", "tag"), remove = FALSE)


# Hinterlasst 4145 Reihen welche nicht auf Datum gewechselt werden können
# Deshalb parse_date nutzen und Format angeben
# ehedaten %>% 
#  janitor::clean_names() %>% 
#   mutate(entstehungszeitraum2 = lubridate::ymd(entstehungszeitraum)) %>% 
#    filter(is.na(entstehungszeitraum))
  


```


```{r}

# Was sind die häufigsten 10 Nachnahmen der Männer?

ehedaten_tidy %>%
  count(nachname_mann) %>% 
  arrange(desc(n))

# Was sind die häufigsten 10 Nachnahmen der Frauen?

ehedaten_tidy %>%
  janitor::clean_names() %>% 
  count(nachname_frau) %>% 
  arrange(desc(n))

# Wieviele Männder mit dem Nachnamen Huber, haben Frauen mit dem Nachnamen Huber geheiratet? 
# Und wieviele davon haben die gleiche Herkunft?

ehedaten_tidy %>% 
  filter(nachname_mann == "Huber" & nachname_frau == "Huber") %>% 
  filter(herkunft_mann == herkunft_frau)

# Für wieviele Jahre gibt es Eheschliessungen?

ehedaten_tidy %>% 
  mutate(jahr = year(datum))
  count(jahr) 
  
# Was sind die Top Ten Kirchengemeinden in denen geheiratet wurde?
  
ehedaten_tidy %>% 
  count(kirchgemeinde) %>% 
  arrange(desc(n))

# In welchen Monaten wurde am häufigsten geheiratet?

ehedaten_tidy %>% 
  group_by(monat) %>% 
  count()

# An welchem Tag wurden im Grossmünster die meisten Ehen geschlossen?

ehedaten_tidy %>% 
  filter(kirchgemeinde == "Grossmünster") %>% 
  count(datum) %>% 
  arrange(desc(n))

# Wieviele Ehen wurden im Durchschnitt pro Kirchengemeinde über alle Jahre geschlossen?

ehedaten_tidy %>% 
  group_by(kirchgemeinde, jahr) %>% 
  summarise(
    anzahl = n()
  ) %>% 
  summarise(
    durchschnitt = mean(anzahl),
    median = median(anzahl),
    standardabweichung = sd(anzahl)
  ) %>% 
  arrange(desc(durchschnitt))


# Versuche auf das Ergebnis visuell und über eine zusammenfassende Statistik zu kommen

library(lubridate)

ehedaten_tidy %>% 
  ggplot(aes(x = datum)) +
  geom_histogram(bins = 277) +
  scale_x_date(breaks = "25 years") +
  coord_flip()

# Welche zwei Jahre stechen hier besonders heraus? 

ehedaten_tidy %>% 
  count(jahr) %>% 
  filter(jahr < 1637) %>% 
  arrange(desc(n))

# 

ehedaten_tidy %>% 
  count(monat, tag)  %>% 
  ggplot(aes(x = monat, y = n, group = tag)) +
  geom_line()


ehedaten_tidy %>% 
  count(monat, tag)  %>% 
  ggplot(aes(x = tag, y = n, group = monat, color = monat)) +
  geom_line() +
  facet_wrap(~monat)

ehedaten_tidy %>% 
  count(monat, wochentag) %>% 
   ggplot(aes(x = wochentag, y = n, group = monat, color = monat)) +
  geom_line() +
  facet_wrap(~monat)

ehedaten_tidy %>% 
  count(monat, wochentag) %>% 
  
  ggplot(aes(x = monat, y = n)) +
  geom_col() +
  facet_wrap(~wochentag)


## was ist der prozentuale anteil an Eheschliessungen in den Kirchengemeinden Top Ten Kirchengemeinden

ehedaten_tidy %>% 
  count(kirchgemeinde) %>% 
  mutate(prozent = n / sum(n) * 100) %>% 
  arrange(desc(n))

# identifiziere die Top 10 Kirchengemeinden und speicher das Ergenis der
# Kirchengemeinden als Vektor

top_10_kirchegemeinden <- ehedaten_tidy %>% 
  #filter(!kirchgemeinde %in% c("Grossmünster", "St. Peter")) %>% 
  count(kirchgemeinde) %>% 
  arrange(desc(n)) %>% 
  head(10) %>% 
  pull(kirchgemeinde)


ehedaten_tidy %>% 
  filter(kirchgemeinde %in% top_10_kirchegemeinden) %>% 
  count(kirchgemeinde, monat, wochentag) %>% 
  
  ggplot(aes(x = monat, y = n)) +
  geom_col() +
  facet_wrap(~wochentag)
   

ehedaten_tidy %>% 
  group_by(kirchgemeinde, wochentag) %>% 
  count() %>% 
  group_by(kirchgemeinde) %>% 
  summarise(
    prozent = n / sum(n) * 100
  ) %>% 
  arrange(desc(prozent))
  group_by(kirchgemeinde) %>% 
  summarise(
    prozent = n / sum(n) * 100
  )

```



### Steuerbares Einkommen natürliche Pers. [Mio.Fr.] 

#### Meine Notizen

Ein interessanter Datensatz, welcher es erlaubt einige Konzepte eizuführen:

- read_delim()
- filter(max())
- arrange()
- joins

**TODO**

- Geodaten für Kanton Zürich
- Gemeinden, Population, etc.
- 

```{r}

steuer_nat <- read_delim("https://www.web.statistik.zh.ch/ogd/data/KANTON_ZUERICH_283.csv", delim = ";")

steuer_nat %>% 
  filter(INDIKATOR_JAHR == max(INDIKATOR_JAHR)) %>% 
  arrange(desc(INDIKATOR_VALUE)) %>% 
  filter(BFS_NR != 0) 

ggplot(data = steuer_nat, mapping = aes(x = ))

```

## Übersicht über alle Lernenden im Kanton Zürich

### Daten importieren

1. Code ausführen. Was ist mit der Warnung? Was könnte diese bedeuten?
2. Ladet die CSV lokal auf euer Arbeitsgerät und öffnet diese mit MS Excel
3. Schaut in Zeile 1961 in Spalte A. Was steht dort`? 
4. Beschreibe was mit der Zeile `locale = locale(encoding = "ISO-8859-1")` erreicht wird

```{r}

lernende <- read_csv("https://www.web.statistik.zh.ch/ogd/data/bista/ZH_Uebersicht_alle_Lernende.csv", 
                     locale = locale(encoding = "ISO-8859-1"))

lernende_2019 <- lernende %>% 
  filter(Jahr == 2019) %>% 
  drop_na() 

```


```{r}

lernende %>% 
  glimpse()

```

```{r}

lernende %>% 
  filter(Jahr == 2019) %>% 

ggplot(aes(x = Schultyp, y = Anzahl, fill = Nationalitaet)) +
  geom_col() +
  coord_flip() 


ggplot(lernende_2019, aes(x = Stufe, y = Anzahl, fill = Nationalitaet)) +
  geom_col() +
  coord_flip()

lernende %>%
  filter(Jahr == 2019) %>% 
  filter(Schultyp %in% c("Mittelschule", "Volksschule")) %>% 
  count(Schultyp)
  group_by(Stufe) %>% 
  count()

  
lernende_2019 %>% 
  count(Stufe, Schultyp, wt = Anzahl)

glimpse(lernende)

lernende %>% 
  count(Schultyp)
  gglot(aes(x = Stufe, y = Anzahl)) 

```


## rstatsZH-K002

# Daten - Übungen 

Im Kurs finden immer wieder Übungen mit Daten statt, welche wenig bis keine Manipulationen benötigen um visualisiert zu werden. Diese Datensätze werden hier gesammelt.

## Corona Hilfen im Kulturbereich im Kanton Zürich

### Daten importieren

```{r}
# Daten importieren

corona_kultur <- read_csv("https://www.web.statistik.zh.ch/ogd/data/ji/fk/kultur_ausfallentschaedigung.csv")

```

### Daten erkunden

In der Sparte "Musik" wurden die grössten Beträge für Corona Hilfen im Kulturbereich beantragt und bewilligt. Bei gemeinnützigen Kulturunternhmen und Kulturschaffenden macht dies den grössten Anteil aus.

Danke für die tollen Daten @OpenDataZH und Fachstelle Kultur @KantonZuerich!

```{r}

# Daten visualisieren - Anzahl Anträge nach Sparte und Kategorie

ggplot(data = corona_kultur, 
       mapping =  aes(x = Status, 
                      fill = Sparte)) +
  geom_bar() +
  facet_wrap(~Kategorie, nrow = 3) +
  theme_bw() +
  theme(legend.position = "bottom")

# Daten visualisieren - Beantragte und beschlossene Summe nach Sparte und Kategorie

## Daten Manipulation 

corona_kultur %>% 
  group_by(Kategorie, Sparte) %>% 
  summarise(
    beantragt = sum(Nachgefragt, na.rm = TRUE),
    beschlossen = sum(Beschluss, na.rm = TRUE)
  ) %>% 
  pivot_longer(cols = beantragt:beschlossen, names_to = "typ", values_to = "summe") %>% 
  
  ## Daten Visualisierung 
  
  ggplot(aes(x = reorder(Sparte, summe), y = summe, fill = typ)) +
  geom_col(position = position_dodge()) +
  facet_wrap(~Kategorie) +
  scale_fill_brewer(type = "qual", palette = "Dark2") +
  scale_y_continuous(labels = scales::label_number(scale = 1 / 1e6, prefix = "CHF ")) +
  labs(
    title = "Corona Hilfen im Kulturbereich im Kanton Zürich",
    subtitle = "Beantragte und beschlossene Summe nach Sparte und Kategorie",
    caption = "Datenquelle: Fachstelle OGD des Kantons Zürich",
    x = "",
    y = "Summe in Millionen"
  ) +
  coord_flip() +
  theme_bw(base_size = 16) +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    panel.grid.major.y = element_blank()
  ) 

```

## Covid19 Daten Schweiz

### Daten importieren


```{r}
covid19zh <- read_csv("https://raw.githubusercontent.com/openZH/covid_19/master/COVID19_Fallzahlen_CH_total_v2.csv")
```


### Daten manipulieren

```{r}
covid19zh_n_conf <- covid19zh %>% 
  select(date, abbreviation_canton_and_fl, ncumul_conf) %>% 
  arrange(abbreviation_canton_and_fl, date) %>% 
  group_by(abbreviation_canton_and_fl) %>% 
  mutate(n_conf = ncumul_conf - lag(ncumul_conf))
```

### Daten visualisieren

```{r}

ggplot(data = covid19zh_n_conf, mapping =  aes(x = date, y = n_conf, color = abbreviation_canton_and_fl)) +
  geom_line() +
  facet_wrap(~abbreviation_canton_and_fl) +
  geom_line() +
  scale_x_date(date_labels = "%B %d") # month and day

ggplot(data = covid19zh, 
       mapping = aes(x = date, 
                     y = ncumul_conf)) +
  geom_line() +
  scale_x_date(date_labels = "%W", date_breaks = "2 weeks") # month and day

```


```{r}
```

